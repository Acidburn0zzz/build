# -*- python -*-
# ex: set syntax=python:

# Copyright (c) 2011 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# This is the buildmaster config file for the 'v8' bot. It must
# be installed as 'master.cfg' in your buildmaster's base directory
# (although the filename can be changed with the --basedir option to
# 'mktap buildbot master').

# It has one job: define a dictionary named BuildmasterConfig. This
# dictionary has a variety of keys to control different aspects of the
# buildmaster. They are documented in docs/config.xhtml .

from buildbot.changes import svnpoller
from buildbot.scheduler import Dependent
from buildbot.scheduler import Nightly
from buildbot.scheduler import Scheduler
from buildbot.scheduler import AnyBranchScheduler
from buildbot.scheduler import Triggerable

#from master import build_utils
from master import master_utils
from master import slaves_list
from master.factory import v8_factory
from master.factory import chromium_factory

import config
import branches_cfg

# Get the branches currently tracked on the waterfall, plus the names for the
# slaves on these branches from the branches_cfg.py file.
stable_branch = branches_cfg.stable_branch
beta_branch = branches_cfg.beta_branch
dev_branch = branches_cfg.dev_branch
branch_names = branches_cfg.branch_names

ActiveMaster = config.Master.V8

SVN_POLLER = True

# This is the dictionary that the buildmaster pays attention to. We also use
# a shorter alias to save typing.
c = BuildmasterConfig = {}


####### CHANGESOURCES

# the 'change_source' list tells the buildmaster how it should find out about
# source code changes. Any class which implements IChangeSource can be added
# to this list: there are several in buildbot/changes/*.py to choose from.
def V8TreeFileSplitter(path):
  """split_file for the 'src' project in the trunk."""

  # List of projects we are interested in. The project names must exactly
  # match paths in the Subversion repository, relative to the 'path' URL
  # argument. build_utils.SplitPath() will use them as branch names to
  # kick off the Schedulers for different projects.
  pieces = path.split('/')
  if pieces[0] == 'trunk':
    return ('trunk', '/'.join(pieces[1:]))
  elif pieces[0] == 'branches':
    return ('/'.join(pieces[0:2]),
            '/'.join(pieces[2:]))
  else:
    return None

if SVN_POLLER:
  # Polls config.Master.trunk_url for changes
  # config.Master.trunk_url,
  bleeding_poller = svnpoller.SVNPoller(
      svnurl=config.Master.v8_url,
      split_file=V8TreeFileSplitter,
      pollinterval=10)

  c['change_source'] = [bleeding_poller]


####### SCHEDULERS

## configure the Schedulers
# v8 Scheduler
s_v8 = Scheduler(name='v8_src',
                 branch='branches/bleeding_edge',
                 treeStableTimer=60,
                 builderNames=['V8 Linux',
                               'V8 Linux - debug',
                               'V8 Linux - debug - mozilla',
                               'V8 Linux - debug - sputnik',
                               'V8 Linux - shared',
                               'V8 Linux64',
                               'V8 Linux64 - debug',
                               'V8 Linux64 - debug - mozilla',
                               'V8 Linux64 - debug - sputnik',
                               'V8 Linux - nosnap',
                               'V8 Linux - nosnap - debug',
                               'V8 Linux - nosnap - debug - mozilla',
                               'V8 Linux - nosnap - debug - sputnik',
                               'V8 Linux - isolates',
                               'V8 Linux - nosse2',
                               'V8 Linux - nosse3',
                               'V8 Linux - nosse4',
                               'V8 Win32',
                               'V8 Win32 - mozilla',
                               'V8 Win32 - sputnik',
                               'V8 Win32 - debug - 1',
                               'V8 Win32 - debug - 2',
                               'V8 Win32 - debug - mozilla - 1',
                               'V8 Win32 - debug - mozilla - 2',
                               'V8 Win32 - debug - sputnik - 1',
                               'V8 Win32 - debug - sputnik - 2',
                               'V8 Win64',
                               'V8 Mac',
                               'V8 Mac - debug',
                               'V8 Mac - debug - mozilla',
                               'V8 Linux - arm - sim',
                               'V8 Linux - arm - sim - mozilla',
                               'V8 Linux - arm - sim - debug',
                               'V8 Linux - arm - sim - debug - mozilla - 1',
                               'V8 Linux - arm - sim - debug - mozilla - 2',
                               'V8 Linux - arm - sim - debug - sputnik',
                               'V8 Linux - arm - sim - novfp3',
                               'Vista Perf',
                               'Mac10.6 Perf',
                               'Linux Interactive (dbg)',
                               'Win Reliability Builder',
                               'Webkit',
                               'Webkit Mac',
                               'Webkit Linux',
                               'Webkit Linux 64'])


s_v8_trunk = Scheduler(name='v8_trunk',
                       branch='trunk',
                       treeStableTimer=60,
                       builderNames=['V8 Linux - trunk',
                                     'V8 arm - sim - trunk',
                                     'V8 Linux64 - trunk'])

s_v8_stable = Scheduler(name='v8_stable',
                        branch='branches/' + stable_branch,
                        treeStableTimer=60,
                        builderNames=[branch_names['stable']['ia32'],
                                      branch_names['stable']['x64'],
                                      branch_names['stable']['arm']])

s_v8_beta = Scheduler(name='v8_beta',
                     branch='branches/' + beta_branch,
                     treeStableTimer=60,
                      builderNames=[branch_names['beta']['ia32'],
                                    branch_names['beta']['x64'],
                                    branch_names['beta']['arm']])

s_v8_dev = Scheduler(name='v8_dev',
                     branch='branches/' + dev_branch,
                     treeStableTimer=60,
                        builderNames=[branch_names['dev']['ia32'],
                                      branch_names['dev']['x64'],
                                      branch_names['dev']['arm']])

# We only tests the 2.5 branch on arm since this is what is
# currently used on android.
s_v8_2_5 = Scheduler(name='v8_2_5',
                     branch='branches/2.5',
                     treeStableTimer=60,
                     builderNames=['V8 arm - sim - 2.5 branch'])

# Scheduler to trigger slaves that depend on the release build.
s_v8_arm_builder = Scheduler(name='v8_arm_builder',
                             branch='branches/bleeding_edge',
                             treeStableTimer=60,
                             builderNames=['V8 Arm - builder'])

s_v8_arm_dependent = Dependent('v8_arm_dependent',
                               s_v8_arm_builder,
                               ['V8 Arm - tester'])


# These builders runs daily. The perf runners because they make the waterfall
# hang. TODO(ricow) - test if this is still the case on the new waterfall.
s_v8_daily = Nightly(name='v8_thrice_daily',
                     builderNames=['V8 Fuzzer',],
                     hour=[19],
                     minute=30)

# A triggerable scheduler used for the reliability tests.
s_win_reliability = Triggerable('reliability', ['Win Reliability'])

c['schedulers'] = [s_v8, s_v8_daily, s_v8_arm_builder, s_v8_arm_dependent,
                   s_win_reliability, s_v8_trunk, s_v8_stable,
                   s_v8_beta, s_v8_dev, s_v8_2_5]


# buildbot/process/factory.py provides several BuildFactory classes you can
# start with, which implement build processes for common targets (GNU
# autoconf projects, CPAN perl modules, etc). The factory.BuildFactory is the
# base class, and is configured with a series of BuildSteps. When the build
# is run, the appropriate buildslave is told to execute each Step in turn.

# the first BuildStep is typically responsible for obtaining a copy of the
# sources. There are source-obtaining Steps in buildbot/process/step.py for
# CVS, SVN, and others.

builders = []

# ----------------------------------------------------------------------------
# FACTORIES

m_linux = v8_factory.V8Factory('v8', target_platform='linux2',
                               sputnik_revision='97')

m_linux_stable = v8_factory.V8Factory('v8', target_platform='linux2',
                                             branch='branches/' + stable_branch,
                                             sputnik_revision='94')

m_linux_beta = v8_factory.V8Factory('v8', target_platform='linux2',
                                           branch='branches/' + beta_branch,
                                           sputnik_revision='94')

m_linux_dev = v8_factory.V8Factory('v8', target_platform='linux2',
                                          branch='branches/' + dev_branch,
                                          sputnik_revision='97')

m_linux_branch_2_5 = v8_factory.V8Factory('v8', target_platform='linux2',
                                          branch='branches/2.5',
                                          sputnik_revision='94')

m_linux_trunk = v8_factory.V8Factory('v8', target_platform='linux2',
                                     branch='trunk',
                                     sputnik_revision='97')

m_linux64_stable = v8_factory.V8Factory('v8', target_platform='linux64',
                                        branch='branches/' + stable_branch,
                                        sputnik_revision='94')

m_linux64_beta = v8_factory.V8Factory('v8', target_platform='linux64',
                                      branch='branches/' + beta_branch,
                                      sputnik_revision='94')

m_linux64_dev = v8_factory.V8Factory('v8', target_platform='linux64',
                                     branch='branches/' + dev_branch,
                                     sputnik_revision='97')

m_linux64_trunk = v8_factory.V8Factory('v8', target_platform='linux64',
                                       branch='trunk',
                                       sputnik_revision='97')

m_linux64 = v8_factory.V8Factory('v8', target_platform='linux64',
                                 sputnik_revision='97')

m_win32 = v8_factory.V8Factory('v8', target_platform='win32',
                               sputnik_revision='97')

m_mac = v8_factory.V8Factory('v8', target_platform='darwin',
                             sputnik_revision='97')

# Note target platform is still win32 - because this is how it is done in scons.
# This is intentionally left as a seperate builder in case this changes.
m_win64 = v8_factory.V8Factory('v8', target_platform='win32',
                               sputnik_revision='97')

v8_arm_builder_archive = ('http://%s/'
                         'v8-arm-builder/chrome_staging/'
                         'full-build-linux.zip' %
                         'vm54-m3')


crosstool_prefix = (
  '/usr/local/crosstool-trusted/arm-2009q3/bin/arm-none-linux-gnueabi/'
  'bin/arm-none-linux-gnueabi')


F = chromium_factory.ChromiumFactory
def win(): return F('src/build', 'win32')
def win_webkit(): return F('src/webkit', 'win32')
def mac(): return F('src/build', 'darwin')
def linux(): return F('src/build', 'linux2')

# The identifier of the factory is the build configuration. If two factories
# are using the same build configuration, they should have the same identifier.

# The identifier of the factory is the build configuration. If two factories
# are using the same build configuration, they should have the same identifier.

f_v8_linux = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'])


f_v8_linux_shared = m_linux.V8Factory(
    options=['library=shared',
             'snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'])


f_v8_linux_debug = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['v8testing', 'v8_es5conform'])

f_v8_linux_debug_mozilla = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['mozilla'])

f_v8_linux_debug_sputnik = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['sputnik'])

f_v8_linux64 = m_linux64.V8Factory(
    options=['snapshot=on',
             'arch=x64',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'],
    target_arch='x64')

f_v8_linux64_debug = m_linux64.V8Factory(
    options=['snapshot=on',
             'cctests',
             'preparser',
             'd8',
             'arch=x64',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['v8testing', 'v8_es5conform'],
    target_arch='x64')

f_v8_linux64_debug_mozilla = m_linux64.V8Factory(
    options=['snapshot=on',
             'cctests',
             'preparser',
             'd8',
             'arch=x64',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['mozilla'],
    target_arch='x64')

f_v8_linux64_debug_sputnik = m_linux64.V8Factory(
    options=['snapshot=on',
             'cctests',
             'preparser',
             'd8',
             'arch=x64',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['sputnik'],
    target_arch='x64')

f_v8_linux_nosnap = m_linux.V8Factory(
    options=['cctests',
             'preparser',
             'd8',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'])

f_v8_linux_nosnap_debug = m_linux.V8Factory(
    options=['cctests',
             'preparser',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['v8testing', 'v8_es5conform'])

f_v8_linux_nosnap_debug_mozilla = m_linux.V8Factory(
    options=['cctests',
             'preparser',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['mozilla'])

f_v8_linux_nosnap_debug_sputnik = m_linux.V8Factory(
    options=['cctests',
             'preparser',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['sputnik'])

f_v8_linux_arm_sim = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik'],
    target_arch='arm')

f_v8_linux_arm_sim_mozilla = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    tests=['mozilla'],
    target_arch='arm')

f_v8_linux_arm_sim_debug = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['v8testing', 'v8_es5conform'],
    target_arch='arm')

f_v8_linux_arm_sim_debug_mozilla = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['mozilla'],
    target_arch='arm')

f_v8_linux_arm_sim_debug_mozilla_1 = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['mozilla'],
    target_arch='arm',
    shard_count=2,
    shard_run=1)

f_v8_linux_arm_sim_debug_mozilla_2 = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['mozilla'],
    target_arch='arm',
    shard_count=2,
    shard_run=2)

f_v8_linux_arm_sim_debug_sputnik = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['sputnik'],
    target_arch='arm')

f_v8_linux_arm_sim_novfp3 = m_linux.V8Factory(
    options=['snapshot=on',
             'vfp3=off',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    shell_flags='@ --noenable-vfp3',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'],
    target='release,debug',
    target_arch='arm')

f_v8_win32 = m_win32.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform'])

f_v8_win32_mozilla = m_win32.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    tests=['mozilla'])

f_v8_win32_sputnik = m_win32.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    tests=['sputnik'])

f_v8_win32_debug_1 = m_win32.V8Factory(
      options=['snapshot=on',
               'preparser',
               'cctests',
               'd8',
               '--build-tool=scons_v8'],
      target='debug',
      tests=['v8testing', 'v8_es5conform'],
      shard_count=2,
      shard_run=1)

f_v8_win32_debug_2 = m_win32.V8Factory(
      options=['snapshot=on',
               'preparser',
               'cctests',
               'd8',
               '--build-tool=scons_v8'],
      target='debug',
      tests=['v8testing', 'v8_es5conform'],
      shard_count=2,
      shard_run=2)

f_v8_win32_debug_mozilla_1 = m_win32.V8Factory(
      options=['snapshot=on',
               'preparser',
               'cctests',
               'd8',
               '--build-tool=scons_v8'],
      target='debug',
      tests=['mozilla'],
      shard_count=2,
      shard_run=1)

f_v8_win32_debug_mozilla_2 = m_win32.V8Factory(
      options=['snapshot=on',
               'preparser',
               'cctests',
               'd8',
               '--build-tool=scons_v8'],
      target='debug',
      tests=['mozilla'],
      shard_count=2,
      shard_run=2)

f_v8_win32_debug_sputnik_1 = m_win32.V8Factory(
      options=['snapshot=on',
               'preparser',
               'cctests',
               'd8',
               '--build-tool=scons_v8'],
      target='debug',
      tests=['sputnik'],
      shard_count=2,
      shard_run=1)

f_v8_win32_debug_sputnik_2 = m_win32.V8Factory(
      options=['snapshot=on',
               'preparser',
               'cctests',
               'd8',
               '--build-tool=scons_v8'],
      target='debug',
      tests=['sputnik'],
      shard_count=2,
      shard_run=2)

f_v8_win64 = m_win64.V8Factory(
      options=['cctests',
               'preparser',
               'd8',
               'arch=x64',
               '--build-tool=scons_v8'],
      tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'],
      target_arch='x64')

f_v8_mac = m_mac.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'])

f_v8_mac_debug = m_mac.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik'])

f_v8_mac_debug_mozilla = m_mac.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug',
    tests=['mozilla'])

f_v8_linux_isolates = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug,release',
    isolates=True,
    tests=['v8testing'])

f_v8_linux_nosse2 = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug,release',
    shell_flags='@ --noenable-sse2',
    tests=['v8testing', 'v8_es5conform', 'mozilla', 'sputnik', 'gcmole'])

f_v8_linux_nosse3 = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug,release',
    shell_flags='@ --noenable-sse3',
    tests=['v8testing', 'v8_es5conform', 'mozilla', 'sputnik'])

f_v8_linux_nosse4 = m_linux.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='debug,release',
    shell_flags='@ --noenable-sse4-1',
    tests=['v8testing', 'v8_es5conform', 'mozilla', 'sputnik'])

f_v8_fuzz = m_linux.V8Factory(
    options=['cctests',
             'preparser',
             'd8',
             '--build-tool=scons_v8'],
    target='debug,release',
    tests=['fuzz'])

f_chromium_rel_builder_v8 = win().ChromiumV8LatestFactory(
    clobber=True,
    project='all.sln',
    tests=['reliability'],
    compile_timeout=3600,
    factory_properties={'archive_build': True,
                        'use_build_number': True})

# The Windows reliability bot runs on Linux because it only needs to transfer
# the build from one part of the network to another, and it is easier on Linux.
f_chromium_rel_reliability_v8 = linux().ReliabilityTestsFactory('win_v8_canary')

f_chromium_rel_perf_vista_dual_v8 = win().ChromiumV8LatestFactory(
    project='all.sln;chromium_builder',
    tests=['page_cycler', 'startup', 'dom_perf',
           'memory', 'sunspider', 'v8_benchmark', 'dromaeo'],
    compile_timeout=3600,
    factory_properties={'perf_id': 'chromium-rel-vista-dual-v8',
                        'show_perf_results': True})

f_chromium_dbg_linux_interactive_v8 = linux().ChromiumV8LatestFactory(
    tests=['interactive_ui'],
    options=['interactive_ui_tests'])

f_chromium_rel_mac6_perf_v8 = mac().ChromiumV8LatestFactory(
    tests=['page_cycler', 'startup', 'dom_perf',
           'page_cycler_http', 'tab_switching',
           'sunspider', 'v8_benchmark', 'dromaeo',
           'memory'],
    options=['--', '-project', '../chrome/chrome.xcodeproj'],
    factory_properties={'perf_id': 'chromium-rel-mac6-v8',
                        'show_perf_results': True})

f_webkit_rel_v8 = win_webkit().ChromiumV8LatestFactory(
    tests=['test_shell', 'webkit', 'webkit_unit'],
    factory_properties={'archive_webkit_results': True})

f_webkit_rel_mac_v8 = mac().ChromiumV8LatestFactory(
    tests=['test_shell', 'webkit', 'webkit_unit'],
    factory_properties={'archive_webkit_results': True},
    options=['--', '-project',
             '../webkit/webkit.xcodeproj'])

f_webkit_rel_linux_v8 = linux().ChromiumV8LatestFactory(
    tests=['test_shell', 'webkit', 'webkit_unit'],
    options=['--build-tool=make', 'test_shell', 'test_shell_tests',
             'webkit_unit_tests', 'DumpRenderTree'],
    factory_properties={'archive_webkit_results': True,
                        'gclient_env': {'GYP_GENERATORS' : 'make'}})

f_webkit_rel_linux64_v8 = linux().ChromiumV8LatestFactory(
    tests=['test_shell', 'webkit', 'webkit_unit'],
    options=['--build-tool=make', 'test_shell', 'test_shell_tests',
             'webkit_unit_tests', 'DumpRenderTree'],
    factory_properties={'archive_webkit_results': True,
                        'gclient_env': {'GYP_GENERATORS' : 'make'}})

f_v8_arm_builder = m_linux.V8Factory(
    target='release',
    tests=[],
    compile_timeout=3600,
    options=[
      '--build-tool=scons_v8',
      'arch=arm',
      'preparser',
      'd8',
      'cctests',
      '--crosstool=' + crosstool_prefix],
    factory_properties={'archive_build': True}
    )

f_v8_arm_tester = m_linux.V8Factory(
    build_url=v8_arm_builder_archive,
    target='release',
    slave_type='Tester',
    options=['arch=arm'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'])

f_v8_linux_trunk = m_linux_trunk.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'])

f_v8_linux_stable = m_linux_stable.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'])

f_v8_linux_beta = m_linux_beta.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'])

f_v8_linux_dev = m_linux_dev.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'])


f_v8_linux64_trunk = m_linux64_trunk.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'],
    target_arch='x64')

f_v8_linux64_stable = m_linux64_stable.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'],
    target_arch='x64')

f_v8_linux64_beta = m_linux64_beta.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'],
    target_arch='x64')

f_v8_linux64_dev = m_linux64_dev.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             '--build-tool=scons_v8'],
    target='release,debug',
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla', 'presubmit'],
    target_arch='x64')


f_v8_arm_trunk = m_linux_trunk.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'],
    target='release,debug',
    target_arch='arm')

f_v8_arm_2_5 = m_linux_branch_2_5.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'mozilla'],
    target='release,debug',
    target_arch='arm')

f_v8_arm_stable = m_linux_stable.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'],
    target='release,debug',
    target_arch='arm')

f_v8_arm_beta = m_linux_beta.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'],
    target='release,debug',
    target_arch='arm')

f_v8_arm_dev = m_linux_dev.V8Factory(
    options=['snapshot=on',
             'preparser',
             'cctests',
             'sample=shell',
             'sample',
             'd8',
             'simulator=arm',
             '--build-tool=scons_v8'],
    tests=['v8testing', 'v8_es5conform', 'sputnik', 'mozilla'],
    target='release,debug',
    target_arch='arm')


# ----------------------------------------------------------------------------
# BUILDER DEFINITIONS

# The 'builders' list defines the Builders. Each one is configured with a
# dictionary, using the following keys:
#  name (required): the name used to describe this bilder
#  slavename (required): which slave to use, must appear in c['slaves']
#  builddir (required): which subdirectory to run the builder in
#  factory (required): a BuildFactory to define how the build is run
#  periodicBuildTime (optional): if set, force a build every N seconds
#  category (optional): it is not used in the normal 'buildbot' meaning. It is
#                       used by gatekeeper to determine which steps it should
#                       look for to close the tree.
#


b_v8_linux = {
  'name': 'V8 Linux',
  'builddir': 'v8-linux',
  'factory': f_v8_linux,
  'category': '1Linux'
}

b_v8_linux_debug = {
  'name': 'V8 Linux - debug',
  'builddir': 'v8-linux-debug',
  'factory': f_v8_linux_debug,
  'category': '1Linux'
}

b_v8_linux_debug_mozilla = {
  'name': 'V8 Linux - debug - mozilla',
  'builddir': 'v8-linux-debug-mozilla',
  'factory': f_v8_linux_debug_mozilla,
  'category': '1Linux'
}

b_v8_linux_debug_sputnik = {
  'name': 'V8 Linux - debug - sputnik',
  'builddir': 'v8-linux-debug-sputnik',
  'factory': f_v8_linux_debug_sputnik,
  'category': '1Linux'
}

b_v8_linux_shared = {
  'name': 'V8 Linux - shared',
  'builddir': 'v8-linux-shared',
  'factory': f_v8_linux_shared,
  'category': '1Linux'
}

b_v8_linux64 = {
  'name': 'V8 Linux64',
  'builddir': 'v8-linux64',
  'factory': f_v8_linux64,
  'category': '2Linux64'
}

b_v8_linux64_debug = {
  'name': 'V8 Linux64 - debug',
  'builddir': 'v8-linux64-debug',
  'factory': f_v8_linux64_debug,
  'category': '2Linux64'
}

b_v8_linux64_debug_mozilla = {
  'name': 'V8 Linux64 - debug - mozilla',
  'builddir': 'v8-linux64-debug-mozilla',
  'factory': f_v8_linux64_debug_mozilla,
  'category': '2Linux64'
}

b_v8_linux64_debug_sputnik = {
  'name': 'V8 Linux64 - debug - sputnik',
  'builddir': 'v8-linux64-debug-sputnik',
  'factory': f_v8_linux64_debug_sputnik,
  'category': '2Linux64'
}

b_v8_linux_nosnap = {
  'name': 'V8 Linux - nosnap',
  'builddir': 'v8-linux-nosnap',
  'factory': f_v8_linux_nosnap,
  'category': '1Linux'
}

b_v8_linux_nosnap_debug = {
  'name': 'V8 Linux - nosnap - debug',
  'builddir': 'v8-linux-nosnap-debug',
  'factory': f_v8_linux_nosnap_debug,
  'category': '1Linux'
}

b_v8_linux_nosnap_debug_mozilla = {
  'name': 'V8 Linux - nosnap - debug - mozilla',
  'builddir': 'v8-linux-nosnap-debug-mozilla',
  'factory': f_v8_linux_nosnap_debug_mozilla,
  'category': '1Linux'
}

b_v8_linux_nosnap_debug_sputnik = {
  'name': 'V8 Linux - nosnap - debug - sputnik',
  'builddir': 'v8-linux-nosnap-debug-sputnik',
  'factory': f_v8_linux_nosnap_debug_sputnik,
  'category': '1Linux'
}

b_v8_linux_arm_sim = {
  'name': 'V8 Linux - arm - sim',
  'builddir': 'v8-linux-arm-sim',
  'factory': f_v8_linux_arm_sim,
  'category': '7Arm simulator'
}

b_v8_linux_arm_sim_mozilla = {
  'name': 'V8 Linux - arm - sim - mozilla',
  'builddir': 'v8-linux-arm-sim-mozilla',
  'factory': f_v8_linux_arm_sim_mozilla,
  'category': '7Arm simulator'
}

b_v8_linux_arm_sim_debug = {
  'name': 'V8 Linux - arm - sim - debug',
  'builddir': 'v8-linux-arm-sim-debug',
  'factory': f_v8_linux_arm_sim_debug,
  'category': '7Arm simulator'
}

b_v8_linux_arm_sim_debug_mozilla_1 = {
  'name': 'V8 Linux - arm - sim - debug - mozilla - 1',
  'builddir': 'v8-linux-arm-sim-debug-mozilla-1',
  'factory': f_v8_linux_arm_sim_debug_mozilla_1,
  'category': '7Arm simulator'
}

b_v8_linux_arm_sim_debug_mozilla_2 = {
  'name': 'V8 Linux - arm - sim - debug - mozilla - 2',
  'builddir': 'v8-linux-arm-sim-debug-mozilla-2',
  'factory': f_v8_linux_arm_sim_debug_mozilla_2,
  'category': '7Arm simulator'
}

b_v8_linux_arm_sim_debug_sputnik = {
  'name': 'V8 Linux - arm - sim - debug - sputnik',
  'builddir': 'v8-linux-arm-sim-debug-sputnik',
  'factory': f_v8_linux_arm_sim_debug_sputnik,
  'category': '7Arm simulator'
}

b_v8_linux_arm_sim_novfp3 = {
  'name': 'V8 Linux - arm - sim - novfp3',
  'builddir': 'v8-linux-arm-sim-novfp3',
  'factory': f_v8_linux_arm_sim_novfp3,
  'category': '7Arm simulator'
}

b_v8_win32 = {
  'name': 'V8 Win32',
  'builddir': 'v8-win32',
  'factory': f_v8_win32,
  'category': '3Windows'
}

b_v8_win32_mozilla = {
  'name': 'V8 Win32 - mozilla',
  'builddir': 'win32-mozilla',
  'factory': f_v8_win32_mozilla,
  'category': '3Windows'
}

b_v8_win32_sputnik = {
  'name': 'V8 Win32 - sputnik',
  'builddir': 'win32-sputnik',
  'factory': f_v8_win32_sputnik,
  'category': '3Windows'
}

# Non standard builddir because of path length limit (sputnik tests)
# for all win32 debug slaves.
b_v8_win32_debug_1 = {
  'name': 'V8 Win32 - debug - 1',
  'builddir': 'win-dbg1',
  'factory': f_v8_win32_debug_1,
  'category': '3Windows'
}

b_v8_win32_debug_2 = {
  'name': 'V8 Win32 - debug - 2',
  'builddir': 'win-dbg2',
  'factory': f_v8_win32_debug_2,
  'category': '3Windows'
}

b_v8_win32_debug_mozilla_1 = {
  'name': 'V8 Win32 - debug - mozilla - 1',
  'builddir': 'w32-d-moz1',
  'factory': f_v8_win32_debug_mozilla_1,
  'category': '3Windows'
}

b_v8_win32_debug_mozilla_2 = {
  'name': 'V8 Win32 - debug - mozilla - 2',
  'builddir': 'w32-d-moz2',
  'factory': f_v8_win32_debug_mozilla_2,
  'category': '3Windows'
}

b_v8_win32_debug_sputnik_1 = {
  'name': 'V8 Win32 - debug - sputnik - 1',
  'builddir': 'w32-d-sput1',
  'factory': f_v8_win32_debug_sputnik_1,
  'category': '3Windows'
}

b_v8_win32_debug_sputnik_2 = {
  'name': 'V8 Win32 - debug - sputnik - 2',
  'builddir': 'w32-d-sput2',
  'factory': f_v8_win32_debug_sputnik_2,
  'category': '3Windows'
}

b_v8_mac = {
  'name': 'V8 Mac',
  'builddir': 'v8-mac',
  'factory': f_v8_mac,
  'category': '4Mac'
}

b_v8_mac_debug = {
  'name': 'V8 Mac - debug',
  'builddir': 'v8-mac-debug',
  'factory': f_v8_mac_debug,
  'category': '4Mac'
}

b_v8_mac_debug_mozilla = {
  'name': 'V8 Mac - debug - mozilla',
  'builddir': 'v8-mac-debug-mozilla',
  'factory': f_v8_mac_debug_mozilla,
  'category': '4Mac'
}

b_v8_win64 = {
  'name': 'V8 Win64',
  'builddir': 'v8-win64',
  'factory': f_v8_win64,
  'category': '3Windows'
}

b_v8_linux_isolates = {
  'name': 'V8 Linux - isolates',
  'builddir': 'v8-linux-isolates',
  'factory': f_v8_linux_isolates,
  'category': '1Linux'
}

b_v8_linux_nosse2 = {
  'name': 'V8 Linux - nosse2',
  'builddir': 'v8-linux-nosse2',
  'factory': f_v8_linux_nosse2,
  'category': '1Linux'
}

b_v8_linux_nosse3 = {
  'name': 'V8 Linux - nosse3',
  'builddir': 'v8-linux-nosse3',
  'factory': f_v8_linux_nosse3,
  'category': '1Linux'
}

b_v8_linux_nosse4 = {
  'name': 'V8 Linux - nosse4',
  'builddir': 'v8-linux-nosse4',
  'factory': f_v8_linux_nosse4,
  'category': '1Linux'
}

b_v8_fuzz = {
  'name': 'V8 Fuzzer',
  'builddir': 'v8-fuzz',
  'factory': f_v8_fuzz,
  'category': '9Misc'
}

b_chromium_rel_builder_v8 = {
  'name': 'Win Reliability Builder',
  'builddir': 'chromium-rel-builder-v8',
  'factory': f_chromium_rel_builder_v8,
  'category': '9Misc'
}

b_chromium_rel_reliability_v8 = {
  'name': 'Win Reliability',
  'builddir': 'chromium-rel-reliability-v8',
  'factory': f_chromium_rel_reliability_v8,
  'category': '9Misc'
}

b_chromium_rel_vista_perf_dual_v8 = {
  'name': 'Vista Perf',
  'builddir': 'chromium-rel-vista-perf-dual-v8',
  'factory': f_chromium_rel_perf_vista_dual_v8,
  'category': '9Misc'
}

b_chromium_dbg_linux_interactive_v8 = {
  'name': 'Linux Interactive (dbg)',
  'builddir': 'chromium-dbg-linux-interactive-v8',
  'factory': f_chromium_dbg_linux_interactive_v8,
  'category': '9Misc'
}

b_chromium_rel_mac6_perf_v8 = {
  'name': 'Mac10.6 Perf',
  'builddir': 'chromium-rel-mac6-perf-v8',
  'factory': f_chromium_rel_mac6_perf_v8,
  'category': '9Misc'
}

b_webkit_rel_v8 = {
  'name': 'Webkit',
  'builddir': 'webkit-rel-v8',
  'factory': f_webkit_rel_v8,
  'category': '8Webkit'
}

b_webkit_rel_mac_v8 = {
  'name': 'Webkit Mac',
  'builddir': 'webkit-rel-mac-v8',
  'factory': f_webkit_rel_mac_v8,
  'category': '8Webkit'
}

b_webkit_rel_linux_v8 = {
  'name': 'Webkit Linux',
  'builddir': 'webkit-rel-linux-v8',
  'factory': f_webkit_rel_linux_v8,
  'category': '8Webkit'
}

b_webkit_rel_linux64_v8 = {
  'name': 'Webkit Linux 64',
  'builddir': 'webkit-rel-linux64-v8',
  'factory': f_webkit_rel_linux64_v8,
  'category': '8Webkit'
}

b_v8_arm_builder = {
  'name': 'V8 Arm - builder',
  'builddir': 'v8-arm-builder',
  'factory': f_v8_arm_builder,
  'category': '6Arm'
}

b_v8_arm_tester = {
  'name': 'V8 Arm - tester',
  'builddir': 'v8-arm-tester',
  'factory': f_v8_arm_tester,
  'category': '6Arm'
}

b_v8_linux_trunk = {
  'name': 'V8 Linux - trunk',
  'builddir': 'v8-linux-trunk',
  'factory': f_v8_linux_trunk,
  'category': '5Branches'
}

b_v8_linux_stable = {
  'name': branch_names['stable']['ia32'],
  'builddir': 'v8-linux-stable',
  'factory': f_v8_linux_stable,
  'category': '5Branches'
}

b_v8_linux_beta = {
  'name': branch_names['beta']['ia32'],
  'builddir': 'v8-linux-beta',
  'factory': f_v8_linux_stable,
  'category': '5Branches'
}

b_v8_linux_dev = {
  'name': branch_names['dev']['ia32'],
  'builddir': 'v8-linux-dev',
  'factory': f_v8_linux_dev,
  'category': '5Branches'
}

b_v8_linux64_trunk = {
  'name': 'V8 Linux64 - trunk',
  'builddir': 'v8-linux64-trunk',
  'factory': f_v8_linux64_trunk,
  'category': '5Branches'
}

b_v8_linux64_stable = {
  'name': branch_names['stable']['x64'],
  'builddir': 'v8-linux64-stable',
  'factory': f_v8_linux64_stable,
  'category': '5Branches'
}

b_v8_linux64_beta = {
  'name': branch_names['beta']['x64'],
  'builddir': 'v8-linux64-beta',
  'factory': f_v8_linux64_beta,
  'category': '5Branches'
}

b_v8_linux64_dev = {
  'name': branch_names['dev']['x64'],
  'builddir': 'v8-linux64-dev',
  'factory': f_v8_linux64_dev,
  'category': '5Branches'
}

b_v8_arm_trunk = {
  'name': 'V8 arm - sim - trunk',
  'builddir': 'v8-arm-trunk',
  'factory': f_v8_arm_trunk,
  'category': '5Branches'
}

b_v8_arm_2_5 = {
  'name': 'V8 arm - sim - 2.5 branch',
  'builddir': 'v8-arm-2_5',
  'factory': f_v8_arm_2_5,
  'category': '5Branches'
}

b_v8_arm_stable = {
  'name': branch_names['stable']['arm'],
  'builddir': 'v8-arm-stable',
  'factory': f_v8_arm_stable,
  'category': '5Branches'
}

b_v8_arm_beta = {
  'name': branch_names['beta']['arm'],
  'builddir': 'v8-arm-beta',
  'factory': f_v8_arm_beta,
  'category': '5Branches'
}

b_v8_arm_dev = {
  'name': branch_names['dev']['arm'],
  'builddir': 'v8-arm-dev',
  'factory': f_v8_arm_dev,
  'category': '5Branches'
}


c['builders'] = [b_v8_linux,
                 b_v8_linux_debug,
                 b_v8_linux_debug_mozilla,
                 b_v8_linux_debug_sputnik,
                 b_v8_linux_shared,
                 b_v8_linux64,
                 b_v8_linux64_debug,
                 b_v8_linux64_debug_mozilla,
                 b_v8_linux64_debug_sputnik,
                 b_v8_linux_nosnap,
                 b_v8_linux_nosnap_debug,
                 b_v8_linux_nosnap_debug_mozilla,
                 b_v8_linux_nosnap_debug_sputnik,
                 b_v8_win32,
                 b_v8_win32_mozilla,
                 b_v8_win32_sputnik,
                 b_v8_win32_debug_1,
                 b_v8_win32_debug_2,
                 b_v8_win32_debug_mozilla_1,
                 b_v8_win32_debug_mozilla_2,
                 b_v8_win32_debug_sputnik_1,
                 b_v8_win32_debug_sputnik_2,
                 b_v8_mac,
                 b_v8_mac_debug,
                 b_v8_mac_debug_mozilla,
                 b_v8_fuzz,
                 b_v8_linux_arm_sim,
                 b_v8_linux_arm_sim_mozilla,
                 b_v8_linux_arm_sim_debug,
                 b_v8_linux_arm_sim_debug_mozilla_1,
                 b_v8_linux_arm_sim_debug_mozilla_2,
                 b_v8_linux_arm_sim_debug_sputnik,
                 b_v8_linux_arm_sim_novfp3,
                 b_webkit_rel_v8,
                 b_webkit_rel_mac_v8,
                 b_webkit_rel_linux_v8,
                 b_v8_win64,
                 b_v8_linux_isolates,
                 b_v8_linux_nosse2,
                 b_v8_linux_nosse3,
                 b_v8_linux_nosse4,
                 b_v8_arm_builder,
                 b_v8_arm_tester,
                 b_v8_linux_trunk,
                 b_v8_linux_stable,
                 b_v8_linux_beta,
                 b_v8_linux_dev,
                 b_v8_arm_trunk,
                 b_v8_arm_2_5,
                 b_v8_arm_stable,
                 b_v8_arm_beta,
                 b_v8_arm_dev,
                 b_v8_linux64_trunk,
                 b_v8_linux64_stable,
                 b_v8_linux64_beta,
                 b_v8_linux64_dev,
                 b_chromium_dbg_linux_interactive_v8,
                 b_chromium_rel_mac6_perf_v8,
                 b_chromium_rel_vista_perf_dual_v8,
                 b_chromium_rel_builder_v8,
                 b_chromium_rel_reliability_v8,
                 b_webkit_rel_linux64_v8]

# Associate the slaves to the builders. The configuration is in slaves.cfg.
slaves = slaves_list.SlavesList('slaves.cfg', 'v8')
for builder in c['builders']:
  builder['slavenames'] = slaves.GetSlavesName(builder=builder['name'])


####### BUILDSLAVES

# The 'slaves' list defines the set of allowable buildslaves. List all the
# slaves registered to a builder. Remove dupes.
c['slaves'] = master_utils.AutoSetupSlaves(c['builders'],
                                           config.Master.GetBotPassword())

# Make sure everything works together.
master_utils.VerifySetup(c, slaves)


####### STATUS TARGETS

# Adds common status and tools to this master.
master_utils.AutoSetupMaster(c, ActiveMaster)

from buildbot.status.mail import MailNotifier
mn = MailNotifier(fromaddr=ActiveMaster.from_address,
                  mode='problem',
                  sendToInterestedUsers=True,
                  extraRecipients=['ricow@chromium.org',
                                   'mstarzinger@chromium.org'],
                  lookup=master_utils.FilterDomain())
c['status'].append(mn)

####### PROJECT IDENTITY

# Buildbot master url:
c['buildbotURL'] = 'http://build.chromium.org/p/client.v8/'
c['projectName'] = ActiveMaster.project_name
c['projectURL'] = config.Master.project_url
