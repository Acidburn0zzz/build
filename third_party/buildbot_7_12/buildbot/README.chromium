URL: http://buildbot.net/trac
GIT: git://github.com/nsylvain/buildbot.git in branch "chromium"
Sources: http://github.com/nsylvain/buildbot/tree/chromium
Version: 0.7.12
License: GNU General Public License (GPL) Version 2

This is a forked copy of buildbot v0.7.12 with the modifications living
in github. To list the local modifications, use:
  git log nsylvain/chromium ^v0.7.12
  

The following change has been made to fix issues that are now fixed in
a newer version of the upstream repository.

--- buildbot/status/web/console.py      (revision 54225)
+++ buildbot/status/web/console.py      (working copy)
@@ -431,11 +431,8 @@
                 builds.append(devBuild)

                 # Now break if we have enough builds.
-                current_revision = self.getChangeForBuild(
-                    builder.getBuild(-1), revision)
-                if self.comparator.isRevisionEarlier(
-                    devBuild, current_revision):
-                    break
+                if int(got_rev) < int(revision):
+                    break;


Then made the following embelishment to allow the old behavior for
time based comparators.

--- third_party/buildbot_7_12/buildbot/status/web/console.py    (revision 68693)
+++ third_party/buildbot_7_12/buildbot/status/web/console.py    (working copy)
@@ -450,8 +450,15 @@
                 builds.append(devBuild)

                 # Now break if we have enough builds.
-                if int(got_rev) < int(revision):
-                    break;
+                if self.comparator.getSortingKey() == "when":
+                    current_revision = self.getChangeForBuild(
+                        builder.getBuild(-1), revision)
+                    if self.comparator.isRevisionEarlier(
+                        devBuild, current_revision):
+                        break
+                else:
+                    if int(got_rev) < int(revision):
+                        break;


             build = build.getPreviousBuild()


The following patch was ported back from upstream adding log names and URLs to
the JSON output.

--- third_party/buildbot_7_12/buildbot/status/builder.py	(revision 70505)
+++ third_party/buildbot_7_12/buildbot/status/builder.py	(working copy)
@@ -1132,9 +1132,9 @@
         result['eta'] = self.getETA()
         result['urls'] = self.getURLs()
         result['step_number'] = self.step_number
-        # TODO(maruel): Move that to a sub-url or just publish the log_url
-        # instead.
-        #result['logs'] = self.getLogs()
+        result['logs'] = [[l.getName(),
+            self.build.builder.status.getURLForThing(l)]
+                for l in self.getLogs()]
         return result
 
 
@@ -1565,8 +1565,8 @@
         result['slave'] = self.getSlavename()
         # TODO(maruel): Add.
         #result['test_results'] = self.getTestResults()
-        # TODO(maruel): Include the url? It's too heavy otherwise.
-        #result['logs'] = self.getLogs()
+        result['logs'] = [[l.getName(),
+            self.builder.status.getURLForThing(l)] for l in self.getLogs()]
         result['eta'] = self.getETA()
         result['steps'] = [bss.asDict() for bss in self.steps]
         if self.getCurrentStep():


The following patch disables rss and atom output.

--- a/third_party/buildbot_7_12/buildbot/status/web/baseweb.py
+++ b/third_party/buildbot_7_12/buildbot/status/web/baseweb.py
@@ -594,8 +594,9 @@ class WebStatus(service.MultiService):
             root.putChild(name, child_resource)

         status = self.getStatus()
-        root.putChild("rss", Rss20StatusResource(status))
-        root.putChild("atom", Atom10StatusResource(status))
+        # Disabled from Chromium.
+        # root.putChild("rss", Rss20StatusResource(status))
+        # root.putChild("atom", Atom10StatusResource(status))
         root.putChild("json", JsonStatusResource(status))

         self.site.resource = root


Fixes c.number is None
--- a/master/buildbot/status/web/status_json.py
+++ b/master/buildbot/status/web/status_json.py
@@ -547,15 +547,13 @@ class ChangesJsonResource(JsonResource):
     def __init__(self, status, changes):
         JsonResource.__init__(self, status)
         for c in changes:
-            # TODO(maruel): Problem with multiple changes with the same number.
-            # Probably try server hack specific so we could fix it on this side
-            # instead. But there is still the problem with multiple pollers from
-            # different repo where the numbers could clash.
-            number = str(c.number)
-            while number in self.children:
-                # TODO(maruel): Do something better?
-                number = str(int(c.number)+1)
-            self.putChild(number, ChangeJsonResource(status, c))
+            # c.number can be None or clash another change if the change was
+            # generated inside buildbot or if using multiple pollers.
+            if c.number is not None and str(c.number) not in self.children:
+                self.putChild(str(c.number), ChangeJsonResource(status, c))
+            else:
+                # Temporary hack since it creates information exposure.
+                self.putChild(str(id(c)), ChangeJsonResource(status, c))

     def asDict(self, request):
         """Don't throw an exception when there is no child."""

